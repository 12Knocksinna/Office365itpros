

$StartDate = (Get-Date).AddDays(-180).toString('yyyy-MM-ddT00:00:00Z')
$EndDate = (Get-Date).AddDays(1).toString('yyyy-MM-ddT00:00:00Z')
$User = Get-MgUser -UserId Tony.Redmond@redmondassociates.org

$Uri = ("https://graph.microsoft.com/beta/copilot/users/{0}/getAllEnterpriseInteractions?`$filter=createdDateTime gt {1} and createdDateTime lt {2}" `
    -f $User.Id, $StartDate, $EndDate)
Write-Host ("Searching for Copilot interactions for {0} between {1} and {2}" -f $User.DisplayName, $StartDate, $EndDate)
[array]$CopilotData = $null
# Get the first set of records
$Data = Invoke-MgGraphRequest -Uri $Uri -Method GET
$CopilotData = $Data.Value

$Nextlink = $Data.'@odata.nextLink'
While ($null -ne $Nextlink) {
    Write-Host ("Fetching more records - currently at {0}" -f $CopilotData.count)
    [array]$Data = Invoke-MgGraphRequest -Uri $Nextlink -Method Get
    $Users = $CopilotData += $Data.Value
    $Nextlink = $Data.'@odata.nextLink'
}
# Remove any null records
$CopilotData = $CopilotData | Where-Object { $_ -ne $null }

Write-Host ("All {0} Copilot interactions for {1} between {2} and {3} have been retrieved" -f $CopilotData.count, $User.DisplayName, $StartDate, $EndDate)
$Report = [System.Collections.Generic.List[Object]]::new()

ForEach ($Record in $CopilotData) {

    If ($Record.createdDateTime) {
        $Timestamp = Get-Date $Record.createdDateTime -format 'dd-MMM-yyyy HH:mm:ss'
    } else {
        $Timestamp = $null
    }
    Switch ($Record.interactionType) {
        "userPrompt" {
            $AppName = $User.displayname
            $AppId = $record.from.user.id
        }
        "aiResponse" {
            $AppName = $Record.from.application.displayname
            $AppId = $Record.from.application.id
        }
        Default {
            $AppName = $Record.interfrom.application.displayname
            $AppId = $Record.from.application.id
        }
    }

    If ($Record.body.content.length -gt 100) {
        $Body = $Record.body.content.ToString().Substring(0,100)
    } else {
        $Body = $Record.body.content.ToString()
    }

    If ($AppName -eq 'Copilot in Word' -and $Body.Substring(0,15) -eq "[AutoGenerated]") {
        $AutoGeneratedFlag = $True
    } else {
        $AutoGeneratedFlag = $False
    }
    $ReportLine = [pscustomobject]@{
        User            = $User.UserPrincipalName
        Timestamp       = $Timestamp
        'Copilot App'   = $AppName
        AppId           = $AppId
        Contexts        = ($Record.contexts -join ", ")
        InteractionType = $Record.interactionType
        ThreadId        = $Record.sessionid
        Body            = $Body
        Attachments     = ($Record.attachments -join ", ")
        Mentions        = $Record.mentions
        AutoGenerated   = $AutoGeneratedFlag
    }
    $Report.Add($ReportLine)
}